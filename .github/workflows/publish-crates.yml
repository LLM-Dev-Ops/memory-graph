name: Publish to crates.io

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 0.1.0)'
        required: true
        type: string
  push:
    tags:
      - 'v*.*.*'

env:
  CARGO_TERM_COLOR: always

jobs:
  publish:
    name: Publish Rust crate to crates.io
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          components: rustfmt, clippy

      - name: Install protoc
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler
          protoc --version

      - name: Cache cargo registry
        uses: actions/cache@v3
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-

      - name: Cache cargo index
        uses: actions/cache@v3
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-git-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-git-

      - name: Cache cargo build
        uses: actions/cache@v3
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-build-

      - name: Verify version in Cargo.toml
        if: github.event_name == 'push'
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          CARGO_VERSION=$(grep '^version = ' Cargo.toml | head -1 | cut -d'"' -f2)

          if [ "$VERSION" != "$CARGO_VERSION" ]; then
            echo "âŒ Version mismatch!"
            echo "Git tag: v$VERSION"
            echo "Cargo.toml: $CARGO_VERSION"
            exit 1
          fi

          echo "âœ… Version verified: $VERSION"

      - name: Run tests
        run: cargo test --all-features --lib

      - name: Check formatting
        run: cargo fmt -- --check

      - name: Run clippy
        run: cargo clippy --all-features -- -D warnings

      - name: Build release binary
        run: cargo build --release --all-features

      - name: Verify package
        run: cargo package --allow-dirty --list

      - name: Package dry-run
        run: cargo publish --dry-run --allow-dirty

      - name: Publish to crates.io
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CRATES_SECRET }}
        run: |
          echo "ðŸ“¦ Publishing to crates.io..."
          cargo publish --token $CARGO_REGISTRY_TOKEN
          echo "âœ… Successfully published to crates.io!"

      - name: Verify publication
        run: |
          VERSION=$(grep '^version = ' Cargo.toml | head -1 | cut -d'"' -f2)
          echo "ðŸ” Verifying publication of version $VERSION..."
          sleep 30  # Wait for crates.io to index

          if curl -s "https://crates.io/api/v1/crates/llm-memory-graph" | grep -q "\"max_version\":\"$VERSION\""; then
            echo "âœ… Version $VERSION is now available on crates.io!"
          else
            echo "âš ï¸  Package published but not yet indexed (may take a few minutes)"
          fi

      - name: Create release notes
        if: github.event_name == 'push'
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          cat > release-notes.md <<EOF
          # LLM-Memory-Graph v$VERSION

          ## ðŸ“¦ Published Packages

          - **crates.io**: [llm-memory-graph v$VERSION](https://crates.io/crates/llm-memory-graph)
          - **docs.rs**: [Documentation](https://docs.rs/llm-memory-graph/$VERSION)

          ## ðŸš€ Installation

          \`\`\`toml
          [dependencies]
          llm-memory-graph = "$VERSION"
          \`\`\`

          ## ðŸ“š Resources

          - [GitHub Repository](https://github.com/globalbusinessadvisors/llm-memory-graph)
          - [Documentation](https://docs.rs/llm-memory-graph)
          - [Examples](https://github.com/globalbusinessadvisors/llm-memory-graph/tree/main/examples)
          EOF

          echo "Release notes created:"
          cat release-notes.md

      - name: Upload release notes
        if: github.event_name == 'push'
        uses: actions/upload-artifact@v3
        with:
          name: release-notes
          path: release-notes.md
