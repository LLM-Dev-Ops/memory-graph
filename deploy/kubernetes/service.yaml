apiVersion: v1
kind: Service
metadata:
  name: memory-graph
  namespace: llm-memory-graph
  labels:
    app: memory-graph
    component: grpc-service
  annotations:
    service.beta.kubernetes.io/aws-load-balancer-type: "nlb"
    service.beta.kubernetes.io/aws-load-balancer-backend-protocol: "tcp"
    # For Azure AKS:
    # service.beta.kubernetes.io/azure-load-balancer-internal: "false"
    # For GCP GKE:
    # cloud.google.com/neg: '{"ingress": true}'
spec:
  type: LoadBalancer
  sessionAffinity: ClientIP
  sessionAffinityConfig:
    clientIP:
      timeoutSeconds: 10800  # 3 hours
  ports:
  - name: grpc
    port: 50051
    targetPort: 50051
    protocol: TCP
  - name: metrics
    port: 9090
    targetPort: 9090
    protocol: TCP
  selector:
    app: memory-graph

---
# Headless service for StatefulSet scenarios or direct pod access
apiVersion: v1
kind: Service
metadata:
  name: memory-graph-headless
  namespace: llm-memory-graph
  labels:
    app: memory-graph
    component: headless-service
spec:
  type: ClusterIP
  clusterIP: None
  publishNotReadyAddresses: true
  ports:
  - name: grpc
    port: 50051
    targetPort: 50051
    protocol: TCP
  - name: metrics
    port: 9090
    targetPort: 9090
    protocol: TCP
  selector:
    app: memory-graph

---
# Internal ClusterIP service for in-cluster communication
apiVersion: v1
kind: Service
metadata:
  name: memory-graph-internal
  namespace: llm-memory-graph
  labels:
    app: memory-graph
    component: internal-service
spec:
  type: ClusterIP
  ports:
  - name: grpc
    port: 50051
    targetPort: 50051
    protocol: TCP
  - name: metrics
    port: 9090
    targetPort: 9090
    protocol: TCP
  selector:
    app: memory-graph

---
# Optional: NodePort service for development/testing
# apiVersion: v1
# kind: Service
# metadata:
#   name: memory-graph-nodeport
#   namespace: llm-memory-graph
#   labels:
#     app: memory-graph
#     component: nodeport-service
# spec:
#   type: NodePort
#   ports:
#   - name: grpc
#     port: 50051
#     targetPort: 50051
#     nodePort: 30051
#     protocol: TCP
#   - name: metrics
#     port: 9090
#     targetPort: 9090
#     nodePort: 30090
#     protocol: TCP
#   selector:
#     app: memory-graph
